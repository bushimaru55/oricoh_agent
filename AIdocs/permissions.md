# 権限仕様書

## 概要

oricoh_agentの権限管理仕様です。マルチテナント環境でのデータ分離とアクセス制御を定義します。

---

## 権限モデル

### 基本方針
- **マルチテナント分離**: 組織（テナント）ごとにデータを完全に分離
- **ロールベースアクセス制御（RBAC）**: 将来の拡張に対応
- **最小権限の原則**: 必要最小限の権限のみ付与

### 現在の実装（MVP）
- すべてのユーザーは同一権限（組織内の全データにアクセス可能）
- 組織間のデータアクセスは完全に分離

### 将来の拡張
- 管理者/一般ユーザーのロール分離
- 文書ごとのアクセス権限
- 部門・プロジェクト単位のアクセス制御

---

## 1. 認証・認可の基本

### JWT認証
- すべてのAPI（`/api/auth/login`を除く）はJWT認証が必要
- JWTペイロードに`org_id`を含める
- トークン有効期限: 24時間

### 認可チェック
- すべてのAPIリクエストで`org_id`を検証
- リクエストされたリソースがユーザーの`org_id`と一致することを確認
- 不一致の場合は403 Forbiddenを返す

---

## 2. 組織（テナント）レベルの権限

### データ分離の原則
- すべてのデータモデルは`org`（Organization）への外部キーを持つ
- クエリ時は必ず`org_id`でフィルタ
- 他組織のデータは絶対に参照不可

### 実装例
```python
# 正しい実装
Document.objects.filter(org=request.user.org)

# 誤った実装（org_idでフィルタしない）
Document.objects.all()  # 禁止
```

### ストレージ分離
- ファイルパス: `/storage/{org_id}/{filename}`
- ベクトルDB: メタデータに`org_id`を含める
- 組織ごとに物理的に分離

---

## 3. APIエンドポイント別権限

### 認証API

#### POST /api/auth/login
- **権限**: 不要（公開）
- **説明**: ログイン認証

#### POST /api/auth/refresh
- **権限**: 認証済みユーザー
- **説明**: トークンリフレッシュ

### 文書管理API

#### POST /api/document/upload
- **権限**: 認証済みユーザー（同一組織）
- **説明**: 文書アップロード
- **制約**: 
  - ユーザーの`org_id`で文書を紐づけ
  - ファイルサイズ制限: 100MB
  - ファイル形式制限: PDF, DOCX, XLSX, PPTX, 画像

#### GET /api/document/list
- **権限**: 認証済みユーザー（同一組織）
- **説明**: 文書一覧取得
- **制約**: 
  - ユーザーの`org_id`でフィルタ
  - 他組織の文書は表示されない

#### GET /api/document/{id}
- **権限**: 認証済みユーザー（同一組織）
- **説明**: 文書詳細取得
- **制約**: 
  - 文書の`org_id`とユーザーの`org_id`が一致することを確認
  - 不一致の場合は404 Not Found

#### DELETE /api/document/{id}
- **権限**: 認証済みユーザー（同一組織）
- **説明**: 文書削除
- **制約**: 
  - 文書の`org_id`とユーザーの`org_id`が一致することを確認
  - 不一致の場合は404 Not Found

#### POST /api/document/microsoft365/sync
- **権限**: 認証済みユーザー（同一組織）
- **説明**: Microsoft365同期
- **制約**: 
  - ユーザーの`org_id`で同期
  - Microsoft365接続情報が設定されている必要がある

### チャットAPI

#### POST /api/chat/query
- **権限**: 認証済みユーザー（同一組織）
- **説明**: RAG検索・回答生成
- **制約**: 
  - ベクトル検索時に`org_id`でフィルタ
  - 他組織のデータは検索対象外
  - レート制限: 1分あたり10リクエスト

#### GET /api/chat/history
- **権限**: 認証済みユーザー（同一組織）
- **説明**: チャット履歴一覧取得
- **制約**: 
  - ユーザーの`org_id`と`user_id`でフィルタ
  - 他ユーザー・他組織の履歴は表示されない

#### GET /api/chat/history/{id}
- **権限**: 認証済みユーザー（同一組織）
- **説明**: チャット履歴詳細取得
- **制約**: 
  - 履歴の`org_id`と`user_id`がユーザーと一致することを確認
  - 不一致の場合は404 Not Found

### 組織管理API

#### GET /api/organization/info
- **権限**: 認証済みユーザー（同一組織）
- **説明**: 組織情報取得
- **制約**: 
  - ユーザーの`org_id`の組織情報のみ取得
  - 他組織の情報は取得不可

---

## 4. データアクセス制御

### 文書（Document）
- **読み取り**: 同一組織のユーザーは全員アクセス可能
- **作成**: 同一組織のユーザーは全員作成可能
- **更新**: 現在は不可（将来の拡張）
- **削除**: 同一組織のユーザーは全員削除可能

### チャンク（Chunk）
- **読み取り**: 所属文書へのアクセス権限に従う
- **作成**: 文書アップロード時に自動作成
- **更新**: 不可（再処理で再作成）
- **削除**: 所属文書の削除時に自動削除

### Embedding
- **読み取り**: 所属チャンクへのアクセス権限に従う
- **作成**: チャンク作成時に自動作成
- **更新**: 不可（再処理で再作成）
- **削除**: 所属チャンクの削除時に自動削除

### チャット履歴（ChatLog）
- **読み取り**: 作成したユーザーのみアクセス可能
- **作成**: チャット実行時に自動作成
- **更新**: 不可
- **削除**: 現在は不可（将来の拡張）

---

## 5. セキュリティチェックリスト

### バックエンド実装時のチェック項目

- [ ] すべてのAPIエンドポイントでJWT認証を実装
- [ ] JWTから`org_id`を取得し、すべてのクエリでフィルタ
- [ ] リソースアクセス時に`org_id`の一致を確認
- [ ] ファイルパスに`org_id`を含める
- [ ] ベクトル検索時に`org_id`でフィルタ
- [ ] SQLインジェクション対策（ORM使用）
- [ ] XSS対策（フロントエンド側）
- [ ] CSRF対策（トークン検証）
- [ ] レート制限の実装
- [ ] エラーメッセージに機密情報を含めない

### フロントエンド実装時のチェック項目

- [ ] JWTトークンを安全に保存（ローカルストレージ）
- [ ] トークン有効期限切れ時の自動ログアウト
- [ ] 未認証ユーザーのリダイレクト
- [ ] APIエラーハンドリング
- [ ] 入力値のバリデーション
- [ ] ファイルアップロード時のサイズ・形式チェック

---

## 6. 将来の拡張（ロールベースアクセス制御）

### ロール定義（将来）

#### 管理者（Admin）
- 組織内の全データにアクセス可能
- 組織設定の変更
- ユーザー管理
- Microsoft365接続設定

#### 一般ユーザー（User）
- 自分のアップロードした文書にアクセス可能
- 組織内の全文書にアクセス可能（現在の実装）
- チャット機能の利用
- 自分のチャット履歴の閲覧

#### 閲覧者（Viewer）
- 文書の閲覧のみ
- アップロード不可
- チャット機能の利用可

### 権限マトリクス（将来）

| 操作 | 管理者 | 一般ユーザー | 閲覧者 |
|------|--------|------------|--------|
| 文書アップロード | ○ | ○ | × |
| 文書閲覧 | ○ | ○ | ○ |
| 文書削除 | ○ | ○（自分のみ） | × |
| チャット | ○ | ○ | ○ |
| チャット履歴閲覧 | ○（全員分） | ○（自分のみ） | ○（自分のみ） |
| 組織設定変更 | ○ | × | × |
| ユーザー管理 | ○ | × | × |

---

## 7. 実装例

### Django ViewSetでの実装例

```python
from rest_framework import viewsets
from rest_framework.permissions import IsAuthenticated
from rest_framework.decorators import action

class DocumentViewSet(viewsets.ModelViewSet):
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        # org_idで必ずフィルタ
        return Document.objects.filter(org=self.request.user.org)
    
    def perform_create(self, serializer):
        # org_idを自動設定
        serializer.save(org=self.request.user.org)
    
    def retrieve(self, request, *args, **kwargs):
        instance = self.get_object()
        # org_idの一致を確認
        if instance.org != request.user.org:
            return Response(
                {"error": "Not found"},
                status=status.HTTP_404_NOT_FOUND
            )
        return super().retrieve(request, *args, **kwargs)
```

### ベクトル検索での実装例

```python
def search_chunks(org_id, query_vector, top_k=5):
    # org_idで必ずフィルタ
    results = vector_db.search(
        vector=query_vector,
        top_k=top_k,
        filter={"org_id": org_id}  # メタデータでフィルタ
    )
    return results
```

---

## 8. 監査ログ（将来の拡張）

### 記録すべきイベント
- ログイン/ログアウト
- 文書アップロード
- 文書削除
- チャット実行
- 組織設定変更
- ユーザー管理操作

### ログに含める情報
- ユーザーID
- 組織ID
- 操作タイプ
- 操作対象（リソースID）
- タイムスタンプ
- IPアドレス（オプション）

---

## 変更履歴

| 日付 | 変更内容 | 変更理由 |
|------|---------|---------|
| 2024-XX-XX | 初版作成 | プロジェクト開始 |

